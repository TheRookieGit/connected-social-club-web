(()=>{var e={};e.id=744,e.ids=[744],e.modules={20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{"use strict";e.exports=require("buffer")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},68621:e=>{"use strict";e.exports=require("punycode")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},7388:(e,r,s)=>{"use strict";s.r(r),s.d(r,{originalPathname:()=>_,patchFetch:()=>y,requestAsyncStorage:()=>h,routeModule:()=>m,serverHooks:()=>I,staticGenerationAsyncStorage:()=>x});var t={};s.r(t),s.d(t,{GET:()=>g,PUT:()=>f,dynamic:()=>p});var o=s(49303),i=s(88716),n=s(60670),a=s(87070),u=s(41482),c=s.n(u),l=s(85662);let p="force-dynamic";function d(e){if(!e||!e.startsWith("Bearer "))return null;let r=e.substring(7);try{return c().verify(r,process.env.JWT_SECRET||"your-secret-key")}catch(e){return console.error("Token验证失败:",e),null}}async function g(e){try{let r=(0,l.J)();if(!r)return a.NextResponse.json({success:!1,error:"数据库连接失败"},{status:500});let s=e.headers.get("authorization"),t=d(s);if(!t)return a.NextResponse.json({success:!1,error:"未授权访问"},{status:401});console.log("获取用户资料，用户ID:",t.userId),console.log("开始查询用户ID:",t.userId),console.log("使用的Supabase URL:","https://ckhxivbcnagwgpzljzrl.supabase.co");let{data:o,error:i}=await r.from("users").select("*").eq("id",t.userId).single();if(console.log("查询到的用户数据:",o),console.log("bio字段值:",o?.bio),console.log("location字段值:",o?.location),console.log("updated_at字段值:",o?.updated_at),i||!o)return a.NextResponse.json({success:!1,error:"用户不存在"},{status:404});let{data:n,error:u}=await r.from("user_interests").select("interest").eq("user_id",t.userId),{data:c,error:p}=await r.from("user_preferences").select("*").eq("user_id",t.userId).single();return await r.from("user_activity_logs").insert({user_id:t.userId,activity_type:"profile_view",activity_data:{profile_id:t.userId}}),new a.NextResponse(JSON.stringify({success:!0,timestamp:new Date().toISOString(),user:{...o,interests:n?.map(e=>e.interest)||[],preferences:c||null}}),{status:200,headers:{"Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0","Surrogate-Control":"no-store"}})}catch(e){return console.error("获取用户资料错误:",e),a.NextResponse.json({success:!1,error:"服务器错误"},{status:500})}}async function f(e){try{let r=(0,l.J)();if(!r)return a.NextResponse.json({success:!1,error:"数据库连接失败"},{status:500});let s=e.headers.get("authorization");console.log("Authorization header:",s?"存在":"不存在");let t=d(s);if(console.log("Token解码结果:",t),!t)return a.NextResponse.json({success:!1,error:"未授权访问"},{status:401});console.log("用户ID:",t.userId),console.log("用户邮箱:",t.email);let o=await e.json();console.log("接收到的原始数据:",o);let i={};["name","phone","birth_date","gender","avatar_url","bio","location","occupation","education","relationship_status","height","weight"].forEach(e=>{void 0!==o[e]&&(i[e]=o[e],console.log(`字段 ${e}: ${o[e]} -> ${i[e]}`))}),console.log("过滤后的数据:",i),console.log("用户ID:",t.userId),console.log("开始更新数据库...");let{data:n,error:u,count:c}=await r.from("users").update(i).eq("id",t.userId).select().single();if(console.log("更新结果:",{updatedUser:n,updateError:u,count:c}),u)return console.error("更新用户资料错误:",u),a.NextResponse.json({success:!1,error:"更新失败"},{status:500});if(!n)return console.error("更新操作没有返回用户数据"),a.NextResponse.json({success:!1,error:"更新失败 - 没有返回数据"},{status:500});if(console.log("更新后的用户数据:",n),o.interests&&Array.isArray(o.interests)&&(await r.from("user_interests").delete().eq("user_id",t.userId),o.interests.length>0)){let e=o.interests.map(e=>({user_id:t.userId,interest:e.trim()}));await r.from("user_interests").insert(e)}if(o.preferences){let{error:e}=await r.from("user_preferences").upsert({user_id:t.userId,...o.preferences});e&&console.error("更新用户偏好错误:",e)}await r.from("user_activity_logs").insert({user_id:t.userId,activity_type:"profile_update",activity_data:{updated_fields:Object.keys(i)}});let{data:p}=await r.from("user_interests").select("interest").eq("user_id",t.userId),{data:g}=await r.from("user_preferences").select("*").eq("user_id",t.userId).single();return new a.NextResponse(JSON.stringify({success:!0,message:"更新成功",timestamp:new Date().toISOString(),user:{...n,interests:p?.map(e=>e.interest)||[],preferences:g||null}}),{status:200,headers:{"Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0","Surrogate-Control":"no-store"}})}catch(e){return console.error("更新用户资料错误:",e),a.NextResponse.json({success:!1,error:"服务器错误"},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/user/profile/route",pathname:"/api/user/profile",filename:"route",bundlePath:"app/api/user/profile/route"},resolvedPagePath:"/Users/vincent/Desktop/social club web/app/api/user/profile/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:h,staticGenerationAsyncStorage:x,serverHooks:I}=m,_="/api/user/profile/route";function y(){return(0,n.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:x})}},85662:(e,r,s)=>{"use strict";s.d(r,{J:()=>n});var t=s(72438);let o="https://ckhxivbcnagwgpzljzrl.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNraHhpdmJjbmFnd2dwemxqenJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1MjQwMzgsImV4cCI6MjA2OTEwMDAzOH0.ZxoO8QQ9G3tggQFRCHjdnulgv45KtVyx6B7TnqrdHx4";if(!o||!i)throw Error("Missing Supabase environment variables");function n(){try{console.log("创建Supabase客户端..."),console.log("Supabase URL:",o),console.log("Supabase Anon Key exists:",!!i);let e=(0,t.eI)(o,i,{auth:{persistSession:!1}});return console.log("Supabase客户端创建成功"),e}catch(e){return console.error("Supabase客户端创建失败:",e),null}}(0,t.eI)(o,i)}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[276,972,438,482],()=>s(7388));module.exports=t})();