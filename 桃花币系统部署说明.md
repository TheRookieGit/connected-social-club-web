# 桃花币系统部署说明

## 问题说明
"钱包不存在"的错误是因为数据库中缺少桃花币系统所需的表。

## 解决方案

### 方法1：通过Supabase控制台（推荐）

1. 登录你的Supabase控制台
2. 进入你的项目
3. 点击左侧菜单的 "SQL Editor"
4. 复制 `create_currency_tables.sql` 文件中的所有内容
5. 粘贴到SQL编辑器中
6. 点击 "Run" 执行

### 方法2：通过网页界面

1. 访问 `http://localhost:3000/deploy-currency`
2. 点击 "开始部署" 按钮
3. 等待部署完成

### 方法3：手动执行SQL

如果你有数据库访问权限，可以直接执行以下SQL语句：

```sql
-- 创建用户钱包表
CREATE TABLE IF NOT EXISTS user_wallets (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL UNIQUE,
    balance INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建货币交易表
CREATE TABLE IF NOT EXISTS currency_transactions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    amount INTEGER NOT NULL,
    type VARCHAR(50) NOT NULL,
    description TEXT,
    reference_id VARCHAR(100),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建货币规则表
CREATE TABLE IF NOT EXISTS currency_rules (
    id SERIAL PRIMARY KEY,
    rule_code VARCHAR(100) UNIQUE NOT NULL,
    rule_name VARCHAR(200) NOT NULL,
    description TEXT,
    amount INTEGER NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建用户货币收益表
CREATE TABLE IF NOT EXISTS user_currency_earnings (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    rule_id INTEGER NOT NULL,
    earned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id, rule_id, DATE(earned_at))
);

-- 创建货币商品表
CREATE TABLE IF NOT EXISTS currency_products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    price INTEGER NOT NULL,
    category VARCHAR(100),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建用户购买表
CREATE TABLE IF NOT EXISTS user_purchases (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL,
    product_id INTEGER NOT NULL,
    amount INTEGER NOT NULL,
    purchased_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建礼物表
CREATE TABLE IF NOT EXISTS gifts (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    price INTEGER NOT NULL,
    icon_url VARCHAR(500),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建礼物交易表
CREATE TABLE IF NOT EXISTS gift_transactions (
    id SERIAL PRIMARY KEY,
    sender_id INTEGER NOT NULL,
    receiver_id INTEGER NOT NULL,
    gift_id INTEGER NOT NULL,
    amount INTEGER NOT NULL,
    message TEXT,
    sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## 部署完成后

部署完成后，你可以：

1. 访问 `http://localhost:3000/currency` 查看桃花币系统
2. 在用户资料中查看钱包余额
3. 使用桃花币购买商品和发送礼物

## 验证部署

部署成功后，以下API应该能正常工作：
- `GET /api/currency/wallet` - 获取钱包余额
- `GET /api/currency/purchase` - 获取商品列表
- `GET /api/currency/gift` - 获取礼物列表
- `POST /api/currency/earn` - 赚取桃花币 